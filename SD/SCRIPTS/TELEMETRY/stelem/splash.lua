-- Rought map reprojection and coordinates normalization for a small screen
-- Author: Rodrigo Nascimento Hernandez, https://github.com/Rodrigo-NH
--
-- This program is free software; you can redistribute it and/or modify
-- it under the terms of the GNU General Public License as published by
-- the Free Software Foundation; either version 3 of the License, or
-- (at your option) any later version.
--
-- This program is distributed in the hope that it will be useful,
-- but WITHOUT ANY WARRANTY, without even the implied warranty of
-- MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
-- GNU General Public License for more details.
--
-- You should have received a copy of the GNU General Public License
-- along with this program; if not, see <http://www.gnu.org/licenses>.

local shared = ...
    local coords1 = {
        { 1, 1, -20.092816, -44.569596 },
        { 2, 1, -20.092978, -44.569008 },
        { 3, 1, -20.093412, -44.568592 },
        { 4, 1, -20.093512, -44.56794 },
        { 5, 1, -20.094132, -44.56787 },
        { 6, 1, -20.094208, -44.567125 },
        { 7, 1, -20.095037, -44.567279 },
        { 8, 1, -20.095445, -44.566732 },
        { 9, 1, -20.09602, -44.567089 },
        { 10, 1, -20.096595, -44.566837 },
        { 11, 1, -20.097093, -44.567371 },
        { 12, 1, -20.097918, -44.567426 },
        { 13, 1, -20.09793, -44.568151 },
        { 14, 1, -20.098435, -44.568416 },
        { 15, 1, -20.098906, -44.568727 },
        { 16, 1, -20.098772, -44.56951 },
        { 17, 1, -20.099038, -44.570084 },
        { 18, 1, -20.09848, -44.570462 },
        { 19, 1, -20.098435, -44.571178 },
        { 20, 1, -20.098039, -44.571432 },
        { 21, 1, -20.097792, -44.57214 },
        { 22, 1, -20.097109, -44.572252 },
        { 23, 1, -20.09671, -44.572719 },
        { 24, 1, -20.096022, -44.572512 },
        { 25, 1, -20.095355, -44.572776 },
        { 26, 1, -20.095151, -44.572384 },
        { 27, 1, -20.09446, -44.572319 },
        { 28, 1, -20.093803, -44.572019 },
        { 29, 1, -20.093726, -44.571447 },
        { 30, 1, -20.093174, -44.571126 },
        { 31, 1, -20.093254, -44.570414 },
        { 32, 1, -20.092825, -44.570084 },
        { 33, 1, -20.097224, -44.568671 },
        { 34, 1, -20.095958, -44.571031 },
        { 35, 1, -20.095025, -44.570174 },
        { 36, 1, -20.097509, -44.570774 },
        { 37, 1, -20.09691, -44.56967 },
        { 38, 1, -20.095044, -44.568775 },
        { 39, 1, -20.094778, -44.57124 },
        { 40, 1, -20.094102, -44.569508 },
        { 41, 1, -20.096167, -44.568204 },
        { 42, 1, -20.097852, -44.569556 },
        
        -- ================================================
        { 1,2,-20.095852,-44.569902 },
        { 2,2,-20.095852,-44.569951 },
        { 3,2,-20.095836,-44.569959 },
        { 4,2,-20.095818,-44.569948 },
        { 5,2,-20.095818,-44.56986 },
        { 6,2,-20.095823,-44.569863 },
        { 7,2,-20.095835,-44.569872 },
        { 8,2,-20.095835,-44.56992 },
        { 10,2,-20.095857,-44.569953 },
        { 11,2,-20.095885,-44.569971 },
        { 12,2,-20.095885,-44.569895 },
        { 13,2,-20.095902,-44.569885 },
        { 14,2,-20.09587,-44.569864 },
        { 15,2,-20.095841,-44.56988 },
        { 17,2,-20.095849,-44.569861 },
        { 18,2,-20.095835,-44.569852 },
        { 19,2,-20.095834,-44.569804 },
        { 20,2,-20.095864,-44.569788 },
        { 22,2,-20.09589,-44.569798 },
        { 23,2,-20.095902,-44.569807 },
        { 24,2,-20.095889,-44.569814 },
        { 26,2,-20.095886,-44.569863 },
        { 27,2,-20.095885,-44.56982 },
        { 29,2,-20.095882,-44.56984 },
        { 30,2,-20.095862,-44.569839 },
        { 31,2,-20.095856,-44.569845 },
        { 33,2,-20.095856,-44.569833 },
        { 34,2,-20.095862,-44.569839 },
        { 36,2,-20.095884,-44.56982 },
        { 37,2,-20.095862,-44.569819 },
        { 38,2,-20.095855,-44.569825 },
        { 40,2,-20.095856,-44.569812 },
        { 41,2,-20.095862,-44.569817 },
        { 43,2,-20.095834,-44.569793 },
        { 44,2,-20.095835,-44.569743 },
        { 45,2,-20.095867,-44.569727 },
        { 47,2,-20.095839,-44.569792 },
        { 48,2,-20.095852,-44.569785 },
        { 49,2,-20.095852,-44.569764 },
        { 51,2,-20.095856,-44.569776 },
        { 52,2,-20.095874,-44.56979 },
        { 53,2,-20.095882,-44.569793 },
        { 54,2,-20.095886,-44.569787 },
        { 55,2,-20.095886,-44.569746 },
        { 56,2,-20.095901,-44.569738 },
        { 57,2,-20.095873,-44.569719 },
        { 60,2,-20.095869,-44.569765 },
        { 61,2,-20.095869,-44.569745 },
        { 63,2,-20.095869,-44.569721 },
        { 64,2,-20.095819,-44.569718 },
        { 65,2,-20.095819,-44.569688 },
        { 66,2,-20.095869,-44.569691 },
        { 67,2,-20.095869,-44.569677 },
        { 70,2,-20.095874,-44.569669 },
        { 71,2,-20.095886,-44.569678 },
        { 72,2,-20.095886,-44.569716 },
        { 74,2,-20.095868,-44.569672 },
        { 75,2,-20.095819,-44.569669 },
        { 76,2,-20.095819,-44.569639 },
        { 77,2,-20.095868,-44.569642 },
        { 79,2,-20.095868,-44.569638 },
        { 80,2,-20.095868,-44.569614 },
        { 81,2,-20.095886,-44.569629 },
        { 82,2,-20.095886,-44.569667 },
        { 84,2,-20.095923,-44.569944 },
        { 85,2,-20.095923,-44.569965 },
        { 86,2,-20.095906,-44.569973 },
        { 87,2,-20.095906,-44.569862 },
        { 88,2,-20.095924,-44.569875 },
        { 89,2,-20.095924,-44.569905 },
        { 90,2,-20.095928,-44.5699 },
        { 91,2,-20.095974,-44.569903 },
        { 92,2,-20.095973,-44.569952 },
        { 93,2,-20.095927,-44.569949 },
        { 95,2,-20.095927,-44.569878 },
        { 96,2,-20.095939,-44.569885 },
        { 97,2,-20.095939,-44.569896 },
        { 98,2,-20.095974,-44.569879 },
        { 99,2,-20.095974,-44.569848 },
        { 100,2,-20.09599,-44.56984 },
        { 101,2,-20.095978,-44.56983 },
        { 103,2,-20.095923,-44.569865 },
        { 104,2,-20.095923,-44.569837 },
        { 105,2,-20.095939,-44.569828 },
        { 106,2,-20.095956,-44.569837 },
        { 107,2,-20.095956,-44.569865 },
        { 109,2,-20.095939,-44.569866 },
        { 110,2,-20.095939,-44.569846 },
        { 112,2,-20.095956,-44.569823 },
        { 113,2,-20.095905,-44.56982 },
        { 114,2,-20.095906,-44.56979 },
        { 115,2,-20.095957,-44.569793 },
        { 116,2,-20.095957,-44.569779 },
        { 118,2,-20.095974,-44.569819 },
        { 119,2,-20.095973,-44.569779 },
        { 120,2,-20.095961,-44.569771 },
        { 122,2,-20.095977,-44.569713 },
        { 123,2,-20.095989,-44.569721 },
        { 124,2,-20.095973,-44.569731 },
        { 125,2,-20.095973,-44.569761 },
        { 126,2,-20.09594,-44.569779 },
        { 127,2,-20.095939,-44.569767 },
        { 128,2,-20.095923,-44.569757 },
        { 129,2,-20.095923,-44.569718 },
        { 130,2,-20.09594,-44.56971 },
        { 131,2,-20.095956,-44.56972 },
        { 132,2,-20.095956,-44.569749 },
        { 134,2,-20.09594,-44.569748 },
        { 135,2,-20.09594,-44.569727 },
        { 137,2,-20.095962,-44.569827 },
        { 138,2,-20.095967,-44.56982 },
        { 139,2,-20.095972,-44.569828 },
        { 141,2,-20.095962,-44.56971 },
        { 142,2,-20.095967,-44.569702 },
        { 143,2,-20.095972,-44.569711 },
        { 145,2,-20.095958,-44.569705 },
        { 146,2,-20.095943,-44.569704 },
        { 147,2,-20.095923,-44.569688 },
        { 148,2,-20.095923,-44.56964 },
        { 149,2,-20.095957,-44.569621 },
        { 150,2,-20.09599,-44.569643 },
        { 151,2,-20.095978,-44.56965 },
        { 153,2,-20.095974,-44.569701 },
        { 154,2,-20.095974,-44.569656 },
        { 155,2,-20.09595,-44.569656 },
        { 156,2,-20.095946,-44.56966 },
        { 158,2,-20.095944,-44.569649 },
        { 159,2,-20.095949,-44.569655 },
        { 161,2,-20.095944,-44.569681 },
        { 162,2,-20.095949,-44.569676 },
        { 163,2,-20.095973,-44.569677 },
        { 165,2,-20.095949,-44.569675 },
        { 166,2,-20.095945,-44.56967 }                      
     }

local zoom = 64
local factor = 8
local splashlock = 0
local splashwait = getTime()


function shared.run(event)
  lcd.clear()
    
   
  local function splash(coords)
    local destW = 128
    local destH = 64

    local Xmax = 0
    local Xmin = 999999999999999
    local Ymax = 0
    local Ymin = 999999999999999
    local ctr = 0
    for t=1,#coords
    do
              local tx = ((coords[t][4]) + 180) * (destW/360)
        local latRad = (coords[t][3]) * math.pi / 180
        local mercN = math.log(math.tan((math.pi/4)+(latRad/2)))
        local ty = (destH/2)-(destW*mercN/(2*math.pi))        
        coords[t][7] = ty
        coords[t][8] = tx

        if tx > Xmax then
            Xmax = tx
        end
        if tx < Xmin then
            Xmin = tx
        end
        if ty > Ymax then
            Ymax = ty
        end
        if ty < Ymin then
            Ymin = ty
        end
        ctr = ctr + 8
    end

    local xDiff = Xmax - Xmin
    local yDiff = Ymax - Ymin

    local xScale = xDiff / destW
    local yScale = yDiff / destH

    local baseScaleX = (destW - zoom) / xDiff
    local baseScaleY = (destH - zoom) / yDiff

    if yScale > xScale then
        baseScale = baseScaleY
    else
        baseScale = baseScaleX
    end

    local centerY = math.floor((destH - (yDiff * baseScale)) / 2)
    local centerX = math.floor((destW - (xDiff * baseScale)) / 2)

    ctr = 0
    for t=1, #coords
    do
        local destX = math.floor(((coords[t][8] - Xmin) * baseScale) + centerX + 10)
        local destY = math.floor(((coords[t][7] - Ymin) * baseScale) + centerY + 7)
        ctr = ctr + 8
        coords[t][10] = destX
        coords[t][9] = destY
    end

    for g = 1, #coords
    do
        local wpn = coords[g][1] 
        local x1 = coords[g][10]
        local y1 = coords[g][9]

        if x1 <= destW and y1 <= destH and x1 > 0 and y1 > 0 then
            if coords[g][2] == 1 then
            lcd.drawRectangle(x1 - 1, y1 - 1, 3, 3, INVERS)
            end
            if g > 1 then
                local wpn2 = coords[g - 1][1]
                local x2 = coords[g - 1][10]
                local y2 = coords[g - 1][9]
                if wpn - wpn2 == 1 and x2 > 0 and y2 > 0 then
                    if coords[g][2] == 1 then
                        local ha = 0
                        -- lcd.drawLine(x1, y1, x2, y2, DOTTED, FORCE)
                    else
                        lcd.drawLine(x1, y1, x2, y2, SOLID, FORCE)
                    end
                end
            end
        end
    end
end

if splashlock == 0 then
    zoom = zoom - factor
end
    factor = factor + 16
if zoom < -1700 then
    splashlock = 1
    zoom = -1700
end

if getTime() - splashwait > 450 then
    shared.LoadScreen(shared.Screens[1])
end

splash(coords1)

  if event == EVT_VIRTUAL_ENTER then
    shared.LoadScreen(shared.Screens[1])
  end
end

